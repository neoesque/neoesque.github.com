---
layout: post
title: "node.js with Express, Jade, Stylus and CoffeeScript"
date: 2011-05-03
comments: false
tags: ["nodejs"]
categories: ["資訊"]
---

好像不用 node.js 寫一些小東西感覺不出來他的威力 <span style="text-decoration:line-through">而且<a href="http://liangkuo.blogspot.com/">小郭</a>說每次 Demo 都用 Hello World!</span><br /><br />所以決定動手寫一個小小的留言板<br /><br />搭配的 Framework 有 <a href="http://expressjs.com/">Express</a> <a href="http://jashkenas.github.com/coffee-script">CoffeeScript</a> <a href="http://jade-lang.com/">Jade</a> <a href="http://learnboost.github.com/stylus">Stylus</a><br /><br />這些 Framework 功能如下<br /><br /><ul><li>Express : 是 node.js 的 Web Framework</li><li>CoffeeScript : 是快速產生 Javascript 的好物！</li><li>Jade : HTML 的 Template Engine</li><li>Stylus : dynamic stylesheet 簡單的語言產生 css</li></ul><br />功能有<br /><br /><ul><li>新增留言</li><li>修改留言</li><li>刪除留言</li></ul><br /><h3>Demo site 在 <a href="http://nodejs-hello.cloudfoundry.com/">Cloud Foundry</a></h3><br />是透過 VMware 的 Cloud Foundry 執行的<br /><br /><h3>Source Code 在 <a href="https://github.com/neoesque/nodejs-demo">GitHub</a></h3><br />以下是說明~<br /><!--more-->首先請先確認你的環境已經裝好 <a href="http://nodejs.org/">node.js</a>, <a href="http://npmjs.org/">npm</a>, 與 <a href="http://expressjs.com/">Express</a><br /><br />接下來在想要的目錄輸入<br /><br />{% gist 952892 %}<br />會產生如下的目錄架構<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-xWqia9snGiw/Tb-kwd--FBI/AAAAAAAAA3c/JBoCMbi7fPI/s6400/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2011-05-03%2B%25E4%25B8%258B%25E5%258D%25882.46.07.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="278" width="640" src="http://1.bp.blogspot.com/-xWqia9snGiw/Tb-kwd--FBI/AAAAAAAAA3c/JBoCMbi7fPI/s640/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2011-05-03%2B%25E4%25B8%258B%25E5%258D%25882.46.07.png" /></a></div><br />大概就是這樣<br /><br />{% gist 952922 %}<br />其中的 <strong><a href="https://github.com/neoesque/nodejs-demo/blob/master/app.js">app.js</a></strong> 就是主程式裡面包含了 <em>routing</em> 也是 <em>controller</em><br /><br />順帶一提的是 Express 沒有什麼 MVC 的架構(或者說可以自己切 XD) 感覺上他只有包含了 Controller 跟 View<br /><br />因為我們的計畫跑在 VMware Cloud Foundry 上, 所以要加上 <a href="https://github.com/neoesque/nodejs-demo/blob/master/package.json">package.json</a> 內容如下<br /><br />{% gist 952939 %}<br />再下指令<br /><br />{% gist 952945 %}<br /><b>npm 1.0 之後用 npm install -d</b><br /><br />npm 就會幫我們把需要的 Framework 通通裝到 node_modules 裡了<br /><br />所以目前目錄結構如下<br /><br />{% gist 952941 %}<br />都準備好之後終於可以開始寫程式了 XD<br /><br />因為 express 在產生目錄時我們有指定 jade 跟 stylus 當 html 跟 css 的 engine 但是 CoffeeScript 還沒有指定<br /><br />所以為了讓 Express 能吃到 CoffeeScript 所以我們先在 <strong><a href="https://github.com/neoesque/nodejs-demo/blob/master/app.js">app.js</a></strong> 的 app.configure 裡加上一行 app.use(express.compiler({src: __dirname + '/public', enable: ['coffeescript']}));<br /><br />也就是會長這樣拉~ <em>這是 <strong><a href="https://github.com/neoesque/nodejs-demo/blob/master/app.js">app.js</a></strong> 的片段而已</em><br /><br />{% gist 952948 %}<br />所以這樣一來我們的環境也就是 express 就可以支援<br /><ul><li><strong>.jade</strong> 都放在 ./views 底下 由 Jade 翻譯</li><li><strong>.styl</strong> 都放在 ./public/stylesheets 底下 由 Stylus 翻譯</li><li><strong>.coffee</strong> 都放在 ./public/javascripts 底下 由 CoffeeScript 翻譯</li></ul><br />另外為了讓我們的環境可以吃 npm bundle 包的內容以及準備一些環境變數我們把 <strong><a href="https://github.com/neoesque/nodejs-demo/blob/master/app.js">app.js</a></strong> 開頭改成<br /><br />{% gist 952961 %}<br />express 的 Controller-View 的 架構非常簡單<br /><br />以下圖來說 (取自 <strong><a href="https://github.com/neoesque/nodejs-demo/blob/master/app.js#L36">app.js</a></strong> 的一段)<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/--Li416OOzx4/Tb-1uybAU6I/AAAAAAAAA3k/i0Z3C61tSsk/s6400/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2011-05-03%2B%25E4%25B8%258B%25E5%258D%25883.53.21.jpg" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="200" width="640" src="http://1.bp.blogspot.com/--Li416OOzx4/Tb-1uybAU6I/AAAAAAAAA3k/i0Z3C61tSsk/s640/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2011-05-03%2B%25E4%25B8%258B%25E5%258D%25883.53.21.jpg" /></a></div><br /><ol><li> <a href="http://expressjs.com/guide.html#routing">app.get(參數1, 參數2) </a> 的 參數1 是接收的網址 比方說 當網址是 http://xxxxx/ 而且方法是 Get 時就會交由這個 Controller 的 參數2 去處理 <em>( 參數2 必須是 function!)</em></li><li> <a href="http://expressjs.com/guide.html#view-rendering">res.render(參數1, 參數2) </a>的 參數1 是告訴 Jade 要用哪一個 template 去 render 結果上圖表示要用 index.jade 去 render 結果</li><li> res.render(參數1, 參數2) 的 參數2 就是傳遞給 index.jade 的變數 type 必須是 JSON </li></ol><br />Controller 跟 View 的合作很簡單吧 接下來我們看一下 View 怎麼做的<br /><br />首先看 <a href="https://github.com/neoesque/nodejs-demo/blob/master/views/layout.jade">./views/layout.jade</a><br /><br />{% gist 952987 %}<br />第一行的 !!! 5 表示要用 html5 的 doctype 輸出!<br /><br />再來是 <a href="https://github.com/neoesque/nodejs-demo/blob/master/views/index.jade">./views/index.jade</a><br /><br />{% gist 952980 %}<br />如果剛剛 res.render 參數2 的 JSON 裡沒有 layout:false 則所有的結果都會是 layout.jade + 參數1.jade 輸出<br /><br />所以以剛剛的範例來說 title: 'Hello Cloud Foundry' 就會被 layout.jade 的 title= title 吃走<br /><br />而 articles: articles 就會被 index.jade 裡面 - each article, key in articles 的 articles 吃走<br /><br />詳細的 Jade 使用方法可以參考 Jade 官網<br /><br />因為要寫出類似留言板的網站所以我們要一個存檔的功能<br /><br />接下來我們來新增一個 save 的 Controller 方法是 POST 收的參數有一個就是 textarea 裡的 value 啦<br /><br />所以請在 <strong><a href="https://github.com/neoesque/nodejs-demo/blob/master/app.js#L58">app.js</a></strong> 裡新增 一個 app.post('/save', function(){}) 的 method 如下<br /><br />{% gist 953004 %}<br />POST 或 GET 收進來的變數都會由 req.body.[變數] 來取得<br /><br />這邊的設計上 db 裡每一筆資料都是 JSON 裡面有兩個資料 一個是文章 id (由 md5 hash) 是做刪除用的 另一個是文章內容 content<br /><br />而 render 的結果是由 save.jade 處理所以 res.render 的 參數1 我們填 'save'<br /><br />參數2 必須是個 JSON 我們傳了三個東西<br /><ol><li>id : 文章 id</li><li>content : 文章內容</li><li>layout : 要不要套用 layout.jade, 這裡是 false 表示單純輸出 save.jade 的內容就好</li></ol><br />BTW, 這邊的 db 其實我是用 array 做的 可以參考<strong><a href="https://github.com/neoesque/nodejs-demo/blob/master/app.js#L9">app.js</a></strong> 因為 VMware Cloud Foundry 目前還沒支援任何 database (之後會有 MySQL, Redis, 和 MongoDB 的支援)<br /><br />再來我們看一下 <a href="https://github.com/neoesque/nodejs-demo/blob/master/views/save.jade">save.jade</a> 吧<br /><br />{% gist 953008 %}<br />原理很簡單 就是把整塊 div 回傳回去到網頁端的 javascript 直接整個 append 上去就好 (簡單來說我把它當 template 用 XD)<br /><br />再來進階一點我們還想要有修改的功能 一樣的 Controller 只是變成判斷有沒有 文章id 如果有的話就進去 db 尋找 id 有沒有 match 有的話就修改他 沒有文章 id 表示新增文章 因此 Controller 變成這樣<br /><br />{% gist 953009 %}<br />最後我們來稍微看一下 Stylus 跟 CoffeeScript 吧<br /><br />首先是 <a href="https://github.com/neoesque/nodejs-demo/blob/master/public/stylesheets/style.styl">./public/stylesheets/style.styl</a><br /><br />{% gist 953012 %}<br />Stylus 翻譯出來就變這樣!<br />{% gist 953013 %}<br />P.S. 我有偷偷修改 <strong><a href="https://github.com/neoesque/nodejs-demo/blob/master/app.js#L20">app.js</a></strong> 的 app.configure 裡面的 Stylus 加上了 compress : true 讓 translate 出來的 css 有壓縮!<br /><br />至於 javascript 的處理 我們看 <a href="https://github.com/neoesque/nodejs-demo/blob/master/public/javascripts/hello.coffee">./public/javascripts/hello.coffee</a><br /><br />{% gist 953022 %}<br />ㄜ... 這邊要解釋起來有點囉嗦改天再寫一篇 blog 目前請各位去看 docs 吧 XD<br /><br />CoffeeScript 翻譯過的結果就是這樣<br /><br />{% gist 953023 %}<br />很酷 對吧!
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>Tim Wu</div>
<div class='content'>
呵! 正在看這方面的資料, 想不到台灣有人try 這麼快.</div>
</div>
</div>
