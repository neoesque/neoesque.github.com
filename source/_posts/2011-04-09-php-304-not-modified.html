---
layout: post
title: "讓 php 回 304 Not Modified"
date: 2011-04-09
comments: false
---

<div class='post'>
在 Google Page Speed 的要點裡 有提到 <a href="http://code.google.com/intl/zh-TW/speed/page-speed/docs/rtt.html#CombineExternalJS" target="_blank">減少要求 request 的數量</a><br />這樣的話會有兩種作法<br /><br /><ol><li>deploy 時合併成一支大的 .js</li><li>透過 php 把要求的 js 合併一次傳送出去</li></ol><br />但是前者失去了彈性，假設我們有十種不同的元件( js 檔)，因為不是每次都需要這十種元件的功能，所以不可能每次都 loading 這十隻，如果要選擇性的 loading 就要把全部的組合都合併出來，這樣的排列組合未免也太恐怖了。<br /><br />因此實務上會寫一支 php (姑且稱之 combo loader)，透過傳遞不同的 js 元件需求，這隻 combo loader 可以輕鬆的組合出想要的元件。並且可以把合併的結果 cache 起來，下次遇到一樣的需求就不必再重新組合了。<br /><br />因此程式碼大概會長這樣。<br /><!--more--><div id="gist941646"><script type="text/javascript">$(function (){gist('https://gist.github.com/941646.json');});</script></div><br />但是這樣做每次要資料都還是會回應 200 OK 而不能像 js 或 css 回應 304 Not Modified<br /><br />所以我們還要在動一些手腳<br /><br />把回應的 header 加 Expires 跟 Last-Modified 因此大概變成如下<br /><br /><div id="gist941647"><script type="text/javascript">$(function (){gist('https://gist.github.com/941647.json');});</script></div><br />這樣下次有同樣的 request 近來 php 就會先檢查 HTTP_IF_MODIFIED_SINCE 然後透過比對修改的時間決定要回 304 還是重新出檔案了!<br /><br />當然 request 可能會長成這樣<br /><br /><div id="gist941650"><script type="text/javascript">$(function (){gist('https://gist.github.com/941650.json');});</script></div><br />或者防止瀏覽器的 cache 也可以像這樣 loading<br /><br /><div id="gist941651"><script type="text/javascript">$(function (){gist('https://gist.github.com/941651.json');});</script></div><br />最後差異如下<br /><br /><div class="separator" style="clear: both; text-align: center;"><a class="image" href="http://3.bp.blogspot.com/-_uoJgH66ctA/TZ_MbuifuxI/AAAAAAAAA2o/Oy9bGVFVw8A/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7+2011-04-09+%25E4%25B8%258A%25E5%258D%258811.02.06.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="43" src="http://3.bp.blogspot.com/-_uoJgH66ctA/TZ_MbuifuxI/AAAAAAAAA2o/Oy9bGVFVw8A/s640/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7+2011-04-09+%25E4%25B8%258A%25E5%258D%258811.02.06.png" width="640" /></a></div><br /><div class="separator" style="clear: both; text-align: center;"><a class="image" href="http://4.bp.blogspot.com/-w0ZRtO8Lps4/TZ_MbDT7CPI/AAAAAAAAA2k/eEm2lSwezbM/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7+2011-04-09+%25E4%25B8%258A%25E5%258D%258811.01.41.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="63" src="http://4.bp.blogspot.com/-w0ZRtO8Lps4/TZ_MbDT7CPI/AAAAAAAAA2k/eEm2lSwezbM/s640/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7+2011-04-09+%25E4%25B8%258A%25E5%258D%258811.01.41.png" width="640" /></a></div><br />從 132KB 降到 180B ~</div>
