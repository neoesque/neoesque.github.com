<!doctype html>
<html ⚡>
  <head>
    <meta charset="utf-8">
    <link rel="canonical" href="../index.html" >
    <title>Safari 無法建立 nginx ssl_ciphers 使用 RC4 的連線 - Making Life Better</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style>
    <noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    
    
    
    
    <script async custom-element="amp-analytics" src="https://cdn.ampproject.org/v0/amp-analytics-0.1.js"></script>
    
    <script async src="https://cdn.ampproject.org/v0.js"></script>
    <script type="application/ld+json">
		{
			"@context": "http://schema.org",
			"@type": "BlogPosting",
			"headline": "Safari 無法建立 nginx ssl_ciphers 使用 RC4 的連線",
			
			"description": "&lt;p&gt;前幾天幫部門把原本提供 HTTPS 的 squid 換成 nginx，結果馬上被反應 Mac 上面的 Agent 不能連線但是又不知道為什麼，因為其他的瀏覽器 Chrome Firefox 不管作業系統 Windows Linux Mac 上的都可以連真的很弔詭，麻煩同事用跟 Agent 一樣的 Framework 重寫一個簡單的版本也不行，測了很久也找不太到癥結點，後來靈機一動，何不試看看 Safari … 結果果然不出所料… &lt;code&gt;Unable to establish a secure connection&lt;/code&gt; XDDD 搞什麼連 Safari 也連不了，這樣子要 Debug 我就可以自己來了，不然要一直麻煩同事跟我對測不好意思，一開始先用 &lt;code&gt;tcpdump&lt;/code&gt; 發現 Server 送 Certificate 給 Client 之後 Client 就自己斷掉 connection ?! WTF 這太沒有頭緒了吧，後來上網搜尋 &lt;code&gt;ssl connection fail safari&lt;/code&gt;，結果一路看看看就看到了這個 &lt;a href=&#34;https://bugs.launchpad.net/ubuntu/+source/openssl/+bug/965371&#34;&gt;HTTPS requests fail on sites which immediately close the connection if TLS 1.1 negotiation is attempted, on Ubuntu 12.04&lt;/a&gt;，起因是 OpenSSL 1.0.1 的一個 Bug，版上建議降成 OpenSSL 1.0.0 就可以了，因為我要啟用 nginx 的 spdy 所以一定要用 OpenSSL 1.0.1 才可以，不過秉持實驗的精神只好先解除這個功能，於是我就編譯了 nginx with openssl 1.0.0k，然後結果…靠背還是一樣 Safri 不能連其他都可以！不信邪改用 0.9.8y，結果在一模一樣的設定下這個 Safari 就可以連了 = = (這哪招)，總之越來越神秘，只好先回到 nginx with openssl 1.0.1e，(就是死命要 spdy 就對了 XD)，後來在沒什麼想法的情況下只好打開 nginx 的 debug mode &lt;code&gt;error_log xxxxx debug;&lt;/code&gt;，瞧瞧裡面有什麼。&lt;/p&gt;
&lt;p&gt;結果就看到&lt;/p&gt;
&lt;figure class=&#34;highlight plain&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;div class=&#34;line&#34;&gt;1&lt;/div&gt;&lt;div class=&#34;line&#34;&gt;2&lt;/div&gt;&lt;div class=&#34;line&#34;&gt;3&lt;/div&gt;&lt;div class=&#34;line&#34;&gt;4&lt;/div&gt;&lt;div class=&#34;line&#34;&gt;5&lt;/div&gt;&lt;div class=&#34;line&#34;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;div class=&#34;line&#34;&gt;SSL handshake handler: 0&lt;/div&gt;&lt;div class=&#34;line&#34;&gt;[debug] 7585#0: *1 SSL_do_handshake: 0&lt;/div&gt;&lt;div class=&#34;line&#34;&gt;[debug] 7585#0: *1 SSL_get_error: 5&lt;/div&gt;&lt;div class=&#34;line&#34;&gt;[info] 7585#0: *1 peer closed connection in SSL handshake while SSL handshaking, client: x.x.x.x, server: 0.0.0.0:443                                  &lt;/div&gt;&lt;div class=&#34;line&#34;&gt;[debug] 7585#0: *1 close http connection: 14&lt;/div&gt;&lt;div class=&#34;line&#34;&gt;[debug] 7585#0: *1 SSL_shutdown: 1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;",
			
			"mainEntityOfPage":{
			    "@type":"WebPage",
			    "@id":"http://blog.littlero.se/post/nginx-ssl-cipher-rc4-safari/"
			},
			"datePublished": "2013-04-27T05:52:58.000Z",
			"dateModified": "2015-03-14T05:41:29.000Z",
			
			"image": {
				"@type": "ImageObject",
				"url": "/amp-dist/sample/sample-substituteTitleImage.png",
				"width" : "1024",
				"height" : "800"
			},
			
			"author": {
			    "@type": "Person",
			    "name": "neoesque"
			},
			"publisher": {
			    "@type": "Organization",
			    "name": "neoesque"
			    
			    ,
			    "logo": {
			      "@type": "ImageObject",
			      "url": "http://blog.littlero.se/amp-dist/sample/logo.png",
			      "width": 500,
			      "height": 60
			    }
			    
			}
		}
	</script>
	
	<style amp-custom>
		
#header:after,
.nav ul:after {
    content: "."
}
.entry-content ul,
ol,
ul {
    list-style: none
}
.article-nav-link-wrap,
code {
    text-shadow: 0 1px #fff
}
#page-nav a,
.article-nav-link-wrap,
a {
    text-decoration: none
}
#page-nav,
.article-nav-caption,
.nav {
    text-transform: uppercase
}
#footer:after,
#header:after,
.clearfix:after,
.nav ul:after {
    clear: both;
    visibility: hidden
}
a,
abbr,
acronym,
address,
applet,
big,
blockquote,
body,
caption,
cite,
code,
dd,
del,
dfn,
div,
dl,
dt,
em,
fieldset,
form,
h1,
h2,
h3,
h4,
h5,
h6,
html,
iframe,
img,
ins,
kbd,
label,
legend,
li,
object,
ol,
p,
pre,
q,
s,
samp,
small,
span,
strike,
strong,
sub,
sup,
table,
tbody,
td,
tfoot,
th,
thead,
tr,
tt,
ul,
var {
    margin: 0;
    padding: 0;
    border: 0;
    outline: 0;
    font-weight: inherit;
    font-style: inherit;
    font-family: inherit;
    font-size: 100%;
    vertical-align: baseline
}
caption,
table,
td,
th {
    vertical-align: middle
}
table {
    border-collapse: separate;
    border-spacing: 0
}
caption,
td,
th {
    text-align: left;
    font-weight: 400
}
a img {
    border: none
}
button,
input {
    margin: 0;
    padding: 0
}
button::-moz-focus-inner,
input::-moz-focus-inner {
    border: 0;
    padding: 0
}
.boxCaption p,
code,
pre {
    -webkit-border-radius: 5px
}
body {
    line-height: 1;
    background: #fff;
    color: #4f5759;
    font: 105% Meiryo, Osaka, 'MS PGothic', sans-serif;
    text-rendering: optimizelegibility;
    -webkit-text-size-adjust: 100%;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale
}
code,
figure.highlight .code,
pre {
    -webkit-font-smoothing: subpixel-antialiased;
    -moz-osx-font-smoothing: grayscale
}
a {
    -webkit-transition: .7s;
    -moz-transition: .7s;
    -o-transition: .7s;
    -ms-transition: .7s;
    transition: .7s
}
a:hover {
    transition: .3s;
    color: #600c21
}
b,
strong {
    font-weight: 700
}
em {
    font-style: italic
}
del {
    text-decoration: line-through
}
sub,
sup {
    font-size: 75%;
    line-height: 0;
    position: relative
}
:root sub,
:root sup {
    vertical-align: baseline
}
sup {
    top: -.5em
}
sub {
    bottom: -.2em
}
abbr,
acronym {
    border-bottom: 1px dotted;
    font-variant: normal
}
abbr {
    cursor: help
}
h1 a,
h2 a,
h3 a,
h4 a,
h5 a,
h6 a {
    color: #000;
    text-decoration: none
}
h1 a:hover,
h2 a:hover,
h3 a:hover,
h4 a:hover,
h5 a:hover,
h6 a:hover {
    color: #000
}
code,
pre {
    background-color: #f1eeeb;
    padding: 1px 8px;
    margin: 0 3px;
    border-radius: 5px;
    font-weight: 400
}
.alignleft,
.left {
    float: left
}
.alignright,
.right {
    float: right
}
.entry-content .gist {
    background: #fbfbfa;
    border: 1px solid #ddd;
    margin-top: 15px;
    padding: 7px 15px;
    -webkit-border-radius: 2px;
    border-radius: 2px;
    line-height: 1.6;
    overflow: auto;
    color: #666
}
.entry-content .gist .gist-file {
    border: none;
    font-family: inherit;
    margin: 0;
    font-size: 1em;
    letter-spacing: 0em;
}
.entry-content .gist .gist-file .gist-data {
    background: 0 0;
    border-bottom: none
}
.entry-content .gist .gist-file .gist-data pre {
    padding: 0;
    font-family: Menlo, Consolas, Monaco, Consolas, monospace
}
.entry-content .gist .gist-file .gist-meta {
    background: 0 0;
    color: #999;
    margin-top: 5px;
    padding: 0;
    font-size: 100%
}
.entry-content .gist .gist-file .gist-meta a,
.entry-content .gist .gist-file .gist-meta a:visited {
    color: #e94f76
}
figure.highlight {
    background: #fbfbfa;
    border: 1px solid #ede9e5;
    padding: 7px 10px;
    -webkit-border-radius: 5px;
    border-radius: 5px;
    line-height: 2;
    overflow: auto;
    position: relative;
    font-size: .9em;
    margin: 2.2em 0
}
figure.highlight figcaption {
    color: #999;
    margin-bottom: 5px
}
figure.highlight figcaption a {
    position: absolute;
    right: 15px
}
#header,
.blog-title a,
.nav,
.nav-icon {
    position: relative
}
figure.highlight pre {
    background: 0 0;
    border: none;
    padding: 8px;
    margin: 0
}
figure.highlight table {
    margin: 0;
    border-spacing: 0
}
figure.highlight th {
    font-weight: 400;
    border: 0;
    padding: 0
}
figure.highlight td {
    border: 0;
    padding: 0
}
figure.highlight .gutter {
    color: #e0dad3;
    padding-right: 10px;
    text-align: left
}
figure.highlight .code {
    border-left: 1px solid #ede9e5;
    color: #4f5759
}
td.code {
    padding: 0
}
.line {
    line-height: 2em;
    letter-spacing: .05em;
    font-size: 95%
}
pre .comment,
pre .diff .header,
pre .doctype,
pre .javadoc,
pre .lisp .string,
pre .pi,
pre .template_comment {
    color: #cecec1;
    font-wight: normal
}
pre .addition,
pre .css .tag,
pre .keyword,
pre .method,
pre .nginx .title,
pre .request,
pre .status,
pre .winutils {
    color: #1a9ca1
}
pre .command,
pre .hexcolor,
pre .number,
pre .phpdoc,
pre .regexp,
pre .string,
pre .tag .value,
pre .tex .formula {
    color: #6c9a1c
}
pre .built_in,
pre .chunk,
pre .decorator,
pre .id,
pre .identifier,
pre .literal,
pre .localvars,
pre .title,
pre .vhdl {
    color: #b42147
}
pre .attribute,
pre .class .title,
pre .constant,
pre .haskell .type,
pre .lisp .body,
pre .parent,
pre .smalltalk .number,
pre .variable {
    color: #c38700
}
pre .attr_selector,
pre .cdata,
pre .clojure .title,
pre .diff .change,
pre .important,
pre .preprocessor,
pre .preprocessor .keyword,
pre .shebang,
pre .special,
pre .subst,
pre .symbol,
pre .symbol .string {
    color: #816ec5
}
pre .deletion {
    color: #b42147
}
#header {
    display: block;
    margin: 4em 0
}
#header:after {
    display: block;
    font-size: 0;
    height: 0
}
.blog-title {
    font-size: 120%;
    font-weight: 700;
    padding-bottom: .2em;
    letter-spacing: .2em;
    margin: 10px 0
}
.blog-title a {
    left: .1em;
    padding: .4em 0
}
.mobile-nav-panel {
    display: none;
    padding: 15px 0 0
}
.mobile-nav-panel .icon-reorder {
    cursor: pointer;
    display: inline-block;
    width: 18px;
    height: 17px;
    background: url(/images/icon-reorder@2x.png) no-repeat;
    -webkit-background-size: 18px 17px;
    -moz-background-size: 18px 17px;
    background-size: 18px 17px
}
.nav {
    margin: 10px 0;
    font-size: 85%;
    float: right
}
.nav ul {
    display: block;
    margin: 0;
    padding: 0
}
.nav ul:after {
    display: block;
    font-size: 0;
    height: 0
}
.nav li {
    float: left;
    margin: .3em 0 .3em 2em
}
.nav li img {
    vertical-align: middle
}
.nav a {
    font-weight: 700;
    color: #4f5759
}
.nav a:hover {
    color: #e94f76
}
.nav-icon {
    font-family: FontAwesome;
    text-align: center;
    font-size: 105%;
    width: 105%;
    height: 105%;
    padding: 20px 8px;
    cursor: pointer
}
#nav-rss-link:before {
    content: "\f09e"
}
#nav-search-btn:before {
    content: "\f002"
}
#search-form-wrap {
    display: none;
    position: absolute;
    top: 10px;
    width: 150px;
    height: 30px;
    right: 280px;
    opacity: 0;
    -ms-filter: "progid:DXImageTransform.Microsoft.Alpha(Opacity=0)";
    filter: alpha(opacity=0);
    -webkit-transition: .2s ease-out;
    -moz-transition: .2s ease-out;
    -o-transition: .2s ease-out;
    -ms-transition: .2s ease-out;
    transition: .2s ease-out
}
#search-form-wrap.on {
    display: block;
    opacity: 1;
    -ms-filter: none;
    filter: none;
    right: 55px
}
@media (max-width: 767px) {
    #search-form-wrap {
        width: 100%;
        left: -100%
    }
}
.search-form {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    background: #fff;
    padding: 3px 15px;
    -webkit-border-radius: 15px;
    border-radius: 15px;
    -webkit-box-shadow: 0 0 10px rgba(0, 0, 0, .3);
    box-shadow: 0 0 10px rgba(0, 0, 0, .3)
}
.search-form-input {
    border: none;
    background: 0 0;
    color: #4f5759;
    letter-spacing: 1px;
    width: 90%;
    font: 13px Meiryo, Osaka, 'MS PGothic', sans-serif;
    outline: 0
}
.search-form-input::-webkit-search-cancel-button,
.search-form-input::-webkit-search-results-decoration {
    -webkit-appearance: none
}
.search-form-submit {
    position: absolute;
    top: 50%;
    right: 10px;
    margin-top: -7px;
    font: 13px FontAwesome;
    border: none;
    background: 0 0;
    color: #bbb;
    cursor: pointer
}
.search-form-submit:focus,
.search-form-submit:hover {
    color: #777
}
#container {
    width: 1024px;
    margin-left: auto;
    margin-right: auto
}
#main {
    padding-left: 200px
}
.post {
    margin-bottom: 5em;
    position: relative
}
.post .entry-header {
    margin-bottom: 2em
}
.post .entry-title {
    font-size: 220%;
    margin: 0
}
.article-devider {
    width: 8%;
    margin: 5em auto;
    border: 0;
    border-top: 5px solid #ddd
}
.entry-meta-header {
    position: absolute;
    top: .5em;
    left: -200px;
    width: 180px;
    font-size: 85%
}
.entry-meta-header a {
    color: #4f5759
}
.entry-meta-header a:hover {
    color: #e94f76
}
.entry-meta-header .meta-elements {
    display: block;
    margin-bottom: .5em
}
.entry-meta-header .date {
    font-weight: 700;
    font-size: 150%;
    font-family: sans-serif
}
.entry-meta-header .date a {
    color: #9ba4a6
}
.entry-meta-header .date a:hover {
    color: #e94f76
}
.entry-meta-header .commentscount {
    font-size: 90%;
    margin-top: 1.5em
}
.entry-content p {
    letter-spacing: .6pt
}
.entry-content .title.link a:after {
    content: '\f08e';
    color: #999;
    font: 12px FontAwesome;
    padding-left: 10px;
    vertical-align: super
}
.entry-content blockquote,
.entry-content blockquote footer {
    font-family: Meiryo, Osaka, 'MS PGothic', sans-serif
}
#page-nav,
.entry-content dt {
    font-weight: 700
}
.entry-content img,
.entry-content video {
    max-width: 100%;
    height: auto;
    display: block;
    margin: auto
}
.entry-content a[title*=Flickr] img {
    height: auto
}
.entry-content h1,
.entry-content h2,
.entry-content h3,
.entry-content h4,
.entry-content h5,
.entry-content h6 {
    margin: 1em 0 .8em;
    line-height: 1.5
}
.entry-content h1 {
    font-size: 170%
}
.entry-content h2 {
    font-size: 160%
}
.entry-content h3 {
    font-size: 140%
}
.entry-content h4 {
    font-size: 130%
}
.entry-content h5 {
    font-size: 110%
}
.entry-content h6 {
    font-size: 100%
}
.entry-content ol {
    list-style: decimal
}
.entry-content dl,
.entry-content ol,
.entry-content ul {
    padding: 0
}
.entry-content dl li,
.entry-content ol li,
.entry-content ul li {
    margin: .5em;
    line-height: 1.8em
}
.entry-content dl li ol,
.entry-content dl li ul,
.entry-content ol li ol,
.entry-content ol li ul,
.entry-content ul li ol,
.entry-content ul li ul {
    margin-bottom: 2em
}
.entry-content table {
    margin: 2.2em auto;
    width: auto;
    border-collapse: collapse;
    border-spacing: 0;
    font-size: .9em
}
.entry-content th {
    border: 1px solid #c4c4c4;
    background-color: #fdf7f4;
    color: #2b2f30;
    padding: .8em
}
.entry-content td {
    border: 1px solid #ddd;
    padding: .8em;
    line-height: 1.5em
}
.entry-content blockquote {
    margin: 2.2em;
    padding: 1em 20px;
    border-left: 6px solid #ddd;
    background: #f6f6f4;
    color: #777;
    position: relative;
    z-index: 1
}
.entry-content blockquote p {
    margin: 0
}
.entry-content blockquote p:last-child {
    margin-bottom: 0
}
.entry-content blockquote footer {
    font-size: 105%
}
.entry-content blockquote footer cite:before {
    content: "—";
    padding: 0 .5em
}
.entry-content blockquote:before {
    content: "”";
    font-size: 600%;
    line-height: 1em;
    font-family: sans-serif;
    color: #e3e3e3;
    position: absolute;
    right: 0;
    top: 0;
    z-index: -1
}
.entry-content .pullquote {
    border-left: 0;
    font-family: Meiryo, Osaka, 'MS PGothic', sans-serif;
    text-align: left;
    width: 45%;
    margin: 10px 0 0
}
code,
kbd,
pre,
samp {
    font-family: Menlo, Consolas, Monaco, Consolas, monospace
}
.entry-content .pullquote .left {
    margin-left: .5em;
    margin-right: 1em
}
.entry-content .pullquote .right {
    margin-right: .5em;
    margin-left: 1em
}
.entry-content .caption {
    color: #4f5759;
    display: block;
    font-size: .9em;
    margin-top: .5em;
    position: relative;
    text-align: center
}

.entry-content pre {
    padding: 15px;
    background: #f5f5f5;
    border: 0;
    -webkit-border-radius: 3px;
    border-radius: 3px;
    -webkit-background-clip: padding;
    -moz-background-clip: padding;
    background-clip: padding-box;
    overflow-x: auto;
    font-size: 100%;
    line-height: 1.3
}
.entry-content hr {
    width: 20%;
    margin: 3em auto;
    border: 0;
    border-top: 3px solid #d5d5d5
}
.entry-meta-footer {
    font-size: 85%;
    color: #777;
    line-height: 1.5;
    margin-bottom: 1.5em
}
.entry-meta-footer a {
    color: #777
}
.entry-meta-footer a:hover {
    color: #e94f76
}
.entry-meta-footer li {
    list-style-type: none
}
.entry-meta-footer span {
    line-height: 2.5em
}
.entry-meta-footer .category a {
    margin-left: 5px;
    margin-right: 5px
}
.entry-meta-footer .category a:first-child {
    margin-left: 0
}
.entry-meta-footer .category a:last-child {
    margin-right: 0
}
.entry-meta-footer .meta {
    margin-bottom: .7em
}
.article-tag-list {
    padding: 0
}
#article-nav {
    clear: both;
    
    position: relative
}
#article-nav:after,
#article-nav:before {
    content: "";
    display: table
}
#article-nav:after {
    clear: both
}
@media screen and (min-width: 768px) {
    #article-nav {
        margin: 6em 0 50px
    }
    #article-nav:before {
        width: 8px;
        height: 8px;
        position: absolute;
        top: 50%;
        left: 50%;
        margin-top: -4px;
        margin-left: -4px;
        content: "";
        -webkit-border-radius: 50%;
        border-radius: 50%;
        background: #ddd;
        -webkit-box-shadow: 0 1px 2px #fff;
        box-shadow: 0 1px 2px #fff
    }
}
.loadingPutAbsolute,
.moreRead:before,
.titleWrapper {
    position: relative
}
.article-nav-link-wrap {
    color: #999;
    -webkit-box-sizing: border-box;
    -moz-box-sizing: border-box;
    box-sizing: border-box;
    margin-top: 50px;
    text-align: center;
    display: block
}
.article-nav-link-wrap:hover {
    color: #555
}
@media screen and (min-width: 768px) {
    .article-nav-link-wrap {
        width: 50%;
        margin-top: 0
    }
    #article-nav-newer {
        float: left;
        text-align: right;
        padding-right: 20px
    }
    #article-nav-older {
        float: right;
        text-align: left;
        padding-left: 20px
    }
}
#footer .copyright,
#page-nav,
.blog-title-circle,
.entry-content h2,
.entry-content h3,
.entry-content p.openMap,
.moreRead:before,
.useFlame,
kbd {
    text-align: center
}
.article-nav-caption {
    letter-spacing: 2px;
    color: #ddd;
    line-height: 1em;
    font-weight: 700
}
#article-nav-newer .article-nav-caption {
    margin-right: -2px
}
.article-nav-title {
    font-size: .85em;
    line-height: 1.6em;
    margin-top: .5em
}
.archive .post {
    margin-bottom: 0
}
.archive .entry-content h1 {
    font-size: 170%
}
#page-nav {
    font-size: 95%;
    letter-spacing: .1em
}
#page-nav a,
#page-nav span {
    display: inline-block;
    min-width: 1.2em;
    padding: 6px 8px;
    margin: 1px 5px;
    -webkit-border-radius: 3px;
    border-radius: 3px;
    -webkit-background-clip: padding;
    -moz-background-clip: padding;
    background-clip: padding-box
}
#page-nav a {
    color: #4f5759
}
#page-nav a:hover {
    background-color: #f5f5f5
}
#page-nav .page-number {
    display: inline-block
}
#page-nav .current {
    background: #ccc;
    color: #fff
}
#page-nav .space {
    color: #ddd
}
#page-nav .next {
    min-width: 5em
}
.mb-search {
    display: none
}
#footer {
    margin: 3em 0;
    font-size: 70%;
    display: block;
    line-height: 1.6
}
#footer:after {
    display: block;
    font-size: 0;
    height: 0;
    content: "."
}
#footer .footer-blog-title {
    float: left;
    display: inline-block;
    text-transform: uppercase;
    font-size: 120%;
    padding-bottom: .2em;
    letter-spacing: .2em;
    margin: 1em 1.5em 0 0;
    border-bottom: 3px solid #777
}
#footer .footer-blog-title a {
    position: relative;
    left: .1em;
    padding: .4em 0;
    color: #777
}
#footer .footer-blog-title:hover {
    border-color: #e94f76
}
#footer .footer-blog-title:hover a {
    color: #e94f76
}
#footer .copyright {
    display: block;
    font-size: .8em
}
img.responsive-img,
video.responsive-video {
    height: auto;
    max-width: 100%
}
.circle {
    -webkit-border-radius: 50%;
    border-radius: 50%
}
.imgWspace {
    background-color: #fff;
    -webkit-border-radius: 50%;
    border-radius: 50%;
    padding: .5em;
    margin: 0;
    line-height: 0
}
.authorLabel {
    display: inline-block;
    font-size: .3em;
    color: #fff;
    background-color: #88b9c1;
    -webkit-border-radius: .5em;
    border-radius: .5em;
    margin: 0 1em 0 0;
    padding: .1em .6em;
    font-weight: 400
}
.authorC,
.authorP,
.clearfix {
    display: block
}
.photoby,
kbd {
    color: #4f5759
}
.site-author-desc {
    font-size: 1.2em;
    line-height: 2.5em;
    margin-top: 1em
}
.authorCap {
    font-size: 1.5em
}
.profile-link {
    margin-top: 1.5em;
    margin-bottom: 1em
}
.site-author-info {
    margin: 20px 0 0;
    padding: 1.2em;
    background-color: #f3f8f9
}
.authorP {
    width: 20%;
    float: left;
    margin: 2.5% 2.5% 2.5% 0
}
.authorC {
    width: 73%;
    float: right
}
* html .clearfix {
    height: 1%
}
.useFlame,
kbd {
    display: inline-block
}
code,
pre,
samp {
    letter-spacing: .05em;
    font-size: .9em
}
kbd {
    font-size: .85em;
    -webkit-font-smoothing: subpixel-antialiased;
    -moz-osx-font-smoothing: grayscale;
    -webkit-border-radius: 3px;
    border-radius: 3px;
    padding: 6px 8px 3px;
    margin: 5px;
    vertical-align: baseline;
    
    background: #fff;
    border-top: 1px solid #fff;
    border-left: 1px solid #fff;
    border-right: 1px solid #e6e6e6;
    border-bottom: 1px solid #e6e6e6;
    -webkit-box-shadow: 0 0 10px #e8e8e8 inset, 0 1px 0 #c3c3c3, 0 2px 0 #c9c9c9, 0 3px 3px #333;
    box-shadow: 0 0 10px #e8e8e8 inset, 0 1px 0 #c3c3c3, 0 2px 0 #c9c9c9, 0 3px 3px #333;
    text-shadow: 0 1px 0 #fff;
    line-height: 1
}
img.outline {
    border: 1px solid #fff;
    -webkit-box-shadow: 0 0 12px #ddd;
    box-shadow: 0 0 12px #ddd
}
.archiveHeaderWrapper {
    width: 100%
}
.archiveHeaderWrapper .archiveHeader,
.archiveHeaderWrapper .archiveThumbCat {
    display: inline-block;
    vertical-align: middle
}
.archiveThumbCat {
    width: 10%;
    margin: 0 2% 0 0
}
.archiveHeader {
    width: 85%
}
.archiveHeader h1 {
    margin: 0 0 .2em
}
.qsFont {
    font-family: sans-serif;
    font-weight: 700
}
.authorReading {
    font-size: .7em
}
.boxCaption,
.boxCaptionLink {
    position: fixed;
    display: block;
    width: 100%
}
.footer-archive-p {
    margin: 10px 0 0
}
.footer-archive-h {
    font-size: 1.6em;
    text-align: center;
    margin: 1em 0 .5em;
    font-family: Meiryo, Osaka, 'MS PGothic', sans-serif;
    font-wight: normal;
    color: #4f5759
}
.footer-gallery {
    padding: 20px 0
}
p.article-description {
    margin: 0;
    padding: 0
}

.entry-content p {
    font-weight: 500
}
.entry-content p em,
.entry-content p strong {
    padding: 3px;
    margin: 0 2px;
    font-style: normal;
    font-weight: 400;
    color: #000
}
.entry-content p em {
    background-color: #fff9c4;
    -webkit-border-radius: 2px;
    border-radius: 2px
}
.entry-content p strong {
    background-color: #fce4ec;
    -webkit-border-radius: 2px;
    border-radius: 2px
}
.boxCaption {
    font-size: .8em;
    left: 0;
    top: 0
}
.boxCaption p {
    display: block;
    padding: .5em 1em;
    border-radius: 5px;
    text-shadow: 0 0 5px #000;
    filter: dropshadow(#000, 0, 0)
}
.boxCaptionLink {
    left: 0;
    bottom: 0
}
.boxCaptionLink a {
    font-size: .8em;
    padding: .5em 1em;
    -webkit-border-radius: 5px;
    border-radius: 5px;
    font-weight: 700
}
.boxCaptionLink a:link,
.boxCaptionLink a:visited {
    color: #fff;
    background-color: rgba(0, 0, 0, .5)
}
.boxCaptionLink a:hover {
    color: #000;
    background-color: rgba(255, 255, 255, .8)
}
.boxCaptionLink a:active {
    color: #fff;
    background-color: rgba(0, 0, 0, .5)
}
.clearfix:after {
    content: ".";
    display: block;
    height: 0
}
.photoFrame {
    margin: 0
}
.photoFrame-loadingNow {
    width: 100%;
    heigth: 800px
}
.masonry-grid-item {
    width: 33.3%;
    float: left;
    margin: 0
}
.entry-content p.openMap {
    margin: 0;
    font-size: .8em
}
.blog-title {
    border-bottom: none
}
.blog-title-circle {
    width: 6em
}
.blog-title-circle a {
    display: inline-block;
    font-size: 1.8em;
    width: 3.2em;
    height: 3.2em;
    line-height: 3em;
    padding: .1em 0 .1em .2em;
    -webkit-border-radius: 50%;
    border-radius: 50%;
    letter-spacing: .2em;
    -webkit-transition: .8s;
    -moz-transition: .8s;
    -o-transition: .8s;
    -ms-transition: .8s;
    transition: .8s;
    background-color: #fff;
    color: #88b9c1;
    border: 3px solid #88b9c1
}
.blog-title-circle a:hover {
    -webkit-transition: .4s;
    -moz-transition: .4s;
    -o-transition: .4s;
    -ms-transition: .4s;
    transition: .4s;
    background-color: #cbe0e4;
    color: #fff;
    border: 3px solid #cbe0e4
}
.titleWrapper .subBlogTitle {
    position: absolute;
    bottom: -1.4em;
    left: 0;
    right: 0;
    margin: 0 auto;
    font-size: .7em;
    color: #cbe0e4;
    letter-spacing: 0;
    font-family: serif
}
a {
    color: #e94f76
}
.post .entry-title {
    font-weight: 300;
    line-height: 1.5em
}
h1,
h2,
h3,
h4,
h5,
h6 {
    font-weight: 300;
    color: #000
}
.entry-content {
    font-size: 100%
}
.entry-content h2 {
    margin: 2.2em 0 .5em;
    padding: .8em 0;
    border-top: 1px solid #88b9c1;
    border-bottom: 1px solid #88b9c1;
    color: #88b9c1
}
.entry-content h3 {
    margin: 2.2em 0 .5em;
    padding: .8em .5em;
    border-left: 6px solid #cbe0e4;
    border-right: 6px solid #cbe0e4;
    background-color: #edf4f5;
    color: #66a5b0
}
.entry-content h4,
.entry-content h5,
.entry-content h6 {
    margin: 2.2em 0 .5em;
    text-align: left;
    color: #88b9c1
}
.entry-content h4 {
    border-left: 6px solid #cbe0e4;
    color: #66a5b0;
    padding-left: 1.2em
}
.entry-content h5 {
    border-left: 3px solid #cbe0e4;
    padding-left: 1.2em
}
.attention {
    border: 1px solid #ce8a8a
}
.attention h5.label,
.attention h6.label {
    color: #ce8a8a
}
.r-memo {
    border: 1px solid #88b9c1
}
.r-memo h5.label,
.r-memo h6.label {
    color: #88b9c1
}
.r-download {
    border: 1px solid #88a3c1
}
.r-download h5.label,
.r-download h6.label {
    color: #88a3c1
}
.attention,
.r-download,
.r-memo {
    -webkit-border-radius: 5px;
    border-radius: 5px;
    padding: 0;
    margin: 2.2em 0
}
.attention h5.label,
.attention h6.label,
.r-download h5.label,
.r-download h6.label,
.r-memo h5.label,
.r-memo h6.label {
    border: none;
    border-left: none;
    border-right: none;
    border-bottom: none;
    border-top: none;
    background: 0 0;
    background-color: none;
    margin: 1.2em 1.5em;
    padding: 0
}
.attention h6.label,
.r-download h6.label,
.r-memo h6.label {
    font-size: 1em
}
.attention p.label,
.r-download p.label,
.r-memo p.label {
    margin: 1.5em;
    padding: 0;
    font-size: .85em
}
.entry-content p {
    margin: 2.8em 1em;
    line-height: 2.5em
}
.entry-content ol li,
.entry-content ul li {
    font-size: 1em;
    position: relative;
    margin: .2em 0 .2em .5em;
    padding: 0 0 0 .2em
}
.entry-content ul li::after,
.entry-content ul li::before {
    display: block;
    content: '';
    position: absolute
}
.article-category:before,
.article-tag-list-item:before {
    font-family: FontAwesome;
    font-size: 1em;
    line-height: 1em;
    display: inline-block;
    position: relative;
    cursor: pointer;
    text-align: center
}
.entry-content ul li::after {
    top: .6em;
    left: -1em;
    width: .6em;
    height: .6em;
    background-color: #dee1e2;
    -webkit-border-radius: 100%;
    border-radius: 100%
}
.entry-content ol p,
.entry-content ul p {
    margin: 0
}
.entry-content ol p:not(:first-child),
.entry-content ul p:not(:first-child) {
    color: #808b8e
}
.entry-content dl,
.entry-content ol,
.entry-content ul {
    margin: 2.2em 0 2.2em 2.5em
}
.article-tag-list-item {
    float: left;
    margin-right: 10px
}
.article-tag-list-item:before {
    content: "\f02b\a0"
}
.article-category:before {
    content: "\f07b"
}
.copyright {
    text-align: center
}
#footer .copyright span {
    font-size: 15px
}
.copyright-tool {
    font-size: 70%;
    text-align: center;
    font-family: sans-serif
}



/*media query*/
    .mobile-nav-panel,
    .nav ul,
    .nav ul li,
    .nav ul li a {
        display: block
    }
    .blog-title-circle a {
        font-size: 1.4em;
        width: 3.2em;
        height: 3.2em;
        line-height: 3em
    }
    #container {
        width: 93.75%;
    }
    .nav,
    .nav ul li {
        width: 100%;
        margin: 0
    }
    .nav {
        height: 0;
        overflow: hidden;
        position: absolute;
        top: 45px;
        left: 0;
        background-color: #4f5759
    }
    .nav.active {
        height: auto;
        overflow: visible;
        -webkit-transition: all .2s ease-out;
        -moz-transition: all .2s ease-out;
        -o-transition: all .2s ease-out;
        -ms-transition: all .2s ease-out;
        transition: all .2s ease-out;
        z-index: 2
    }
    .nav ul li a {
        border: none;
        padding: 1em .5em;
        color: #fff;
        border-bottom: 1px solid #677174;
        text-align: left
    }
    #search-form-wrap {
        display: none
    }
    #nav-rss-link,
    #nav-search-btn {
        display: none
    }
    #header {
        margin: .5em 0 1em;
        text-align: center;
        position: static
    }
    .blog-title {
        float: none
    }
    #main {
        padding-left: 0;
        margin-bottom: 3em
    }
    .entry-meta-header {
        position: static;
        margin-bottom: 1em;
        width: auto
    }
    .entry-meta-header .meta-elements {
        display: inline;
        margin-right: 1em
    }
    .entry-meta-header .commentscount {
        display: none
    }
    .archive .entry-content h1 {
        font-size: 130%
    }
    .post {
        font-size: 90%
    }
    .post .entry-title {
        font-size: 130%
    }
    .post h1 {
        font-size: 1.2em
    }
    .post .entry-content h2 {
        font-size: 130%;
        margin: 1.8em 0 .5em
    }
    .post .entry-content h3,
    .post .entry-content h4 {
        font-size: 120%;
        margin: 1.8em 0 .5em
    }
    .post .entry-content h5,
    .post .entry-content h6 {
        margin: 1.8em 0 .5em
    }
    .post .entry-content p {
        margin: 1.8em 0;
        line-height: 1.9em;
        letter-spacing: 0em;
        font-size: .9em
    }
    .post .entry-content blockquote p {
        margin: 1em 0
    }
    .post .entry-content blockquote {
        margin: 1.8em 0;
        padding: .5em 20px
    }
    .post .entry-content table {
        font-size: .85em;
        margin: 1.8em auto
    }
    .post .entry-content td,
    .post .entry-content th {
        padding: .6em .4em
    }
    .post .entry-content figure.highlight {
        margin: 1.8em 0
    }
    .post .entry-content figure.highlight table {
        margin: 0;
        border-spacing: 0
    }
    .post .entry-content figure.highlight th {
        border: 0;
        padding: 0
    }
    .post .entry-content figure.highlight td {
        border: 0;
        padding: 0;
        font-size: 1.1em
    }
    .post .entry-content figure.highlight td.code {
        border-left: 1px solid #ede9e5
    }
    .post .entry-content iframe {
        width: 100%
    }
    .post .entry-content p.openMap {
        margin: 0;
        text-align: center;
        font-size: .8em
    }
    .post .entry-content .attention h5.label,
    .post .entry-content .attention h6.label,
    .post .entry-content .r-download h5.label,
    .post .entry-content .r-download h6.label,
    .post .entry-content .r-memo h5.label,
    .post .entry-content .r-memo h6.label {
        margin: 1em 1em 0
    }
    .post .entry-content .attention p.label,
    .post .entry-content .r-download p.label,
    .post .entry-content .r-memo p.label {
        margin: 1em;
        font-size: .85em
    }
    .post .entry-content .attention dl,
    .post .entry-content .attention ol,
    .post .entry-content .attention ul,
    .post .entry-content .r-download dl,
    .post .entry-content .r-download ol,
    .post .entry-content .r-download ul,
    .post .entry-content .r-memo dl,
    .post .entry-content .r-memo ol,
    .post .entry-content .r-memo ul {
        margin: 1em 1em 1em 2em
    }
    .post .entry-content .attention ol li,
    .post .entry-content .attention ul li,
    .post .entry-content .r-download ol li,
    .post .entry-content .r-download ul li,
    .post .entry-content .r-memo ol li,
    .post .entry-content .r-memo ul li {
        font-size: .85em
    }
    .post .entry-content dl,
    .post .entry-content ol,
    .post .entry-content ul {
        margin: 1.8em 0 1.8em 1em
    }
    .post .entry-content dl p,
    .post .entry-content ol p,
    .post .entry-content ul p {
        margin: 0
    }
    .site-author-desc {
        line-height: 2em
    }
    .pagenation a,
    .pagenation span {
        padding: 5px;
        margin: 0
    }
    .mb-search {
        margin-top: 3em;
        margin-bottom: 0;
        display: initial
    }
    .mb-search input {
        background: #fff;
        font-family: Meiryo, Osaka, 'MS PGothic', sans-serif;
        font-size: 15px;
        padding: 5px 10px;
        border-bottom: 2px solid #ddd;
        border: 0;
        width: 100%;
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
        color: #999
    }
    .mb-search input:focus {
        color: #4f5759
    }
    #footer {
        margin: 0 0 3em
    }
    #footer .footer-blog-title {
        float: none;
        margin-bottom: 1em
    }
    .profile-link {
        margin-top: 1.1em
    }
    .shareBtnBlock-circle {
        margin-right: .2em;
        margin-bottom: .5em
    }
    .shareBtnBlock-circle a {
        width: 2.4em;
        height: 2.4em;
        line-height: 2.4em;
        font-size: 1.34em
    }
    .masonry-grid-item {
        width: 33.3%
    }
    .shareLabelTitle,
    .visible-ib-md,
    .visible-ib-sm {
        display: none
    }
    


/*media query end*/



.gravatar-area {
    height: 150px;
    width: 150px;
    padding: 8px;
    -webkit-box-shadow: 0 0 6px 2px rgba(79, 87, 89, .1);
    box-shadow: 0 0 6px 2px rgba(79, 87, 89, .1);
    margin: auto;
    -webkit-border-radius: 50%;
    border-radius: 50%
}
.copyright-tool {
    margin-top: 2em
}
.copyright-title {
    font-size: .8em
}
.homeLink {
    background: #e94f76;
    -webkit-border-radius: 3px;
    border-radius: 3px
}
.homeLink a {
    display: block;
    padding: 1em;
    text-align: center;
    color: #fff
}
.table-align-left {
    text-align: left
}
.table-align-right {
    text-align: right
}
.table-align-center {
    text-align: center
}

	</style>
	
  </head>
  <body>
  	
  	<!-- google analytics -->
  	
  	<amp-analytics type="googleanalytics" id="google-analytics">
		<script type="application/json">
		{
		  "vars": {
		    "account": "UA-37617901-1"
		  },
		  "triggers": {
		    "trackPageview": {
		      "on": "visible",
		      "request": "pageview"
		    }
		  }
		}
		</script>
	</amp-analytics>
	
  	
  	<div id="container">
  	
  		<!-- title -->
	  	<header id="header">
	
	  		
	  		<div class="blog-title">
				<a href="/">
					<amp-img src="/amp-dist/sample/logo.png" width="500" height="60" layout="responsive">
					</amp-img>
				</a>
			</div>
			
			
		</header>
	  	
	  	
	  	<div id="main">
	  	
		    <article id="post-nginx-ssl-cipher-rc4-safari" class="post">
		    	
		    	<!-- datePublished -->
				<footer class="entry-meta-header">
					<span class="meta-elements date">
						<time datetime="2013-4-27" itemprop="datePublished">2013-4-27</time>
					</span>
				</footer>
				
				<!-- entry title -->
				<header class="entry-header">
					
					  <h1 class="article-title entry-title" itemprop="name">
					    Safari 無法建立 nginx ssl_ciphers 使用 RC4 的連線
					  </h1>
					
				</header>
				
				<!-- entry content -->
			    <div class="entry-content ecp">
			  		<p>前幾天幫部門把原本提供 HTTPS 的 squid 換成 nginx，結果馬上被反應 Mac 上面的 Agent 不能連線但是又不知道為什麼，因為其他的瀏覽器 Chrome Firefox 不管作業系統 Windows Linux Mac 上的都可以連真的很弔詭，麻煩同事用跟 Agent 一樣的 Framework 重寫一個簡單的版本也不行，測了很久也找不太到癥結點，後來靈機一動，何不試看看 Safari … 結果果然不出所料… <code>Unable to establish a secure connection</code> XDDD 搞什麼連 Safari 也連不了，這樣子要 Debug 我就可以自己來了，不然要一直麻煩同事跟我對測不好意思，一開始先用 <code>tcpdump</code> 發現 Server 送 Certificate 給 Client 之後 Client 就自己斷掉 connection ?! WTF 這太沒有頭緒了吧，後來上網搜尋 <code>ssl connection fail safari</code>，結果一路看看看就看到了這個 <a href="https://bugs.launchpad.net/ubuntu/+source/openssl/+bug/965371" target="_blank" rel="external">HTTPS requests fail on sites which immediately close the connection if TLS 1.1 negotiation is attempted, on Ubuntu 12.04</a>，起因是 OpenSSL 1.0.1 的一個 Bug，版上建議降成 OpenSSL 1.0.0 就可以了，因為我要啟用 nginx 的 spdy 所以一定要用 OpenSSL 1.0.1 才可以，不過秉持實驗的精神只好先解除這個功能，於是我就編譯了 nginx with openssl 1.0.0k，然後結果…靠背還是一樣 Safri 不能連其他都可以！不信邪改用 0.9.8y，結果在一模一樣的設定下這個 Safari 就可以連了 = = (這哪招)，總之越來越神秘，只好先回到 nginx with openssl 1.0.1e，(就是死命要 spdy 就對了 XD)，後來在沒什麼想法的情況下只好打開 nginx 的 debug mode <code>error_log xxxxx debug;</code>，瞧瞧裡面有什麼。</p>
<p>結果就看到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">SSL handshake handler: 0</div><div class="line">[debug] 7585#0: *1 SSL_do_handshake: 0</div><div class="line">[debug] 7585#0: *1 SSL_get_error: 5</div><div class="line">[info] 7585#0: *1 peer closed connection in SSL handshake while SSL handshaking, client: x.x.x.x, server: 0.0.0.0:443                                  </div><div class="line">[debug] 7585#0: *1 close http connection: 14</div><div class="line">[debug] 7585#0: *1 SSL_shutdown: 1</div></pre></td></tr></table></figure>
<a id="more"></a>
<p>啊靠，搞屁 Safari 直接斷掉 connection，這哪招，於是再用 Chrome 連看看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">SSL handshake handler: 0</div><div class="line">[debug] 8398#0: *1 ssl new session: 67979935:32:139</div><div class="line">[debug] 8398#0: *1 SSL_do_handshake: 1</div><div class="line">[debug] 8398#0: *1 SSL: TLSv1.1, cipher: &quot;ECDHE-RSA-RC4-SHA SSLv3 Kx=ECDH Au=RSA Enc=RC4(128) Mac=SHA1&quot;</div><div class="line">[debug] 8398#0: *1 reusable connection: 1</div></pre></td></tr></table></figure>
<p>Bingo，看到一個關鍵的地方，在 SSL handshake 中，client 發一個簡單的 Hello 給 Sever 後，Server 也會回一個 Hello 給 Client，其中這兩個 Hello 會把自己支援的 SSL版本、加密法包在裡面給對方知道，於是這就回到 nginx 的 ssl 設定了，在 nginx 的 doc <a href="http://nginx.org/en/docs/http/configuring_https_servers.html" target="_blank" rel="external">Configuring HTTPS servers</a> 中，提到了因為要防禦 <a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2011-3389" target="_blank" rel="external">CVE-2011-3389 BEAST Attack</a>，建議把 SSL 設置如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ssl_protocols       SSLv3 TLSv1 TLSv1.1 TLSv1.2;</div><div class="line">ssl_ciphers RC4:HIGH:!aNULL:!MD5;</div><div class="line">ssl_prefer_server_ciphers on;</div></pre></td></tr></table></figure>
<p>這個表示優先使用 RC4 的加密，然後是高安全(超過 128bit)的加密法，不接受 MD5 digest 的方式，所以我們可以看到 Chrome 是採用了 <code>ECDHE-RSA-RC4-SHA</code> (Firefox 也是)，但是 Safari 就這樣直接斷掉 connection… 我真是搞不懂你啊！這時候只好參考一些網路網站(就是拜一拜 Google 大神了)，就看到有個網站可以列出你的瀏覽器支援的 SSL cipher 在此 <a href="https://cc.dcsec.uni-hannover.de" target="_blank" rel="external">SSL Cipher Suite Details of Your Browser</a> 用 Safari 開了一下，如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">Cipher Suites Supported by Your Browser (ordered by preference):</div><div class="line"></div><div class="line">SpecCipher Suite NameKey SizeDescription</div><div class="line">(00,ff)EMPTY-RENEGOTIATION-INFO-SCSV0 BitUsed for secure renegotation.</div><div class="line">(c0,0a)ECDHE-ECDSA-AES256-SHA256 BitKey exchange: ECDH, encryption: AES, MAC: SHA1.</div><div class="line">(c0,09)ECDHE-ECDSA-AES128-SHA128 BitKey exchange: ECDH, encryption: AES, MAC: SHA1.</div><div class="line">(c0,07)ECDHE-ECDSA-RC4128-SHA128 BitKey exchange: ECDH, encryption: RC4, MAC: SHA1.</div><div class="line">(c0,08)ECDHE-ECDSA-3DES-EDE-SHA168 BitKey exchange: ECDH, encryption: 3DES, MAC: SHA1.</div><div class="line">(c0,14)ECDHE-RSA-AES256-SHA256 BitKey exchange: ECDH, encryption: AES, MAC: SHA1.</div><div class="line">(c0,13)ECDHE-RSA-AES128-SHA128 BitKey exchange: ECDH, encryption: AES, MAC: SHA1.</div><div class="line">(c0,11)ECDHE-RSA-RC4128-SHA128 BitKey exchange: ECDH, encryption: RC4, MAC: SHA1.</div><div class="line">(c0,12)ECDHE-RSA-3DES-EDE-SHA168 BitKey exchange: ECDH, encryption: 3DES, MAC: SHA1.</div><div class="line">(c0,04)ECDH-ECDSA-AES128-SHA128 BitKey exchange: ECDH, encryption: AES, MAC: SHA1.</div><div class="line">(c0,05)ECDH-ECDSA-AES256-SHA256 BitKey exchange: ECDH, encryption: AES, MAC: SHA1.</div><div class="line">(c0,02)ECDH-ECDSA-RC4128-SHA128 BitKey exchange: ECDH, encryption: RC4, MAC: SHA1.</div><div class="line">(c0,03)ECDH-ECDSA-3DES-EDE-SHA168 BitKey exchange: ECDH, encryption: 3DES, MAC: SHA1.</div><div class="line">(c0,0e)ECDH-RSA-AES128-SHA128 BitKey exchange: ECDH, encryption: AES, MAC: SHA1.</div><div class="line">(c0,0f)ECDH-RSA-AES256-SHA256 BitKey exchange: ECDH, encryption: AES, MAC: SHA1.</div><div class="line">(c0,0c)ECDH-RSA-RC4128-SHA128 BitKey exchange: ECDH, encryption: RC4, MAC: SHA1.</div><div class="line">(c0,0d)ECDH-RSA-3DES-EDE-SHA168 BitKey exchange: ECDH, encryption: 3DES, MAC: SHA1.</div><div class="line">(00,2f)RSA-AES128-SHA128 BitKey exchange: RSA, encryption: AES, MAC: SHA1.</div><div class="line">(00,05)RSA-RC4128-SHA128 BitKey exchange: RSA, encryption: RC4, MAC: SHA1.</div><div class="line">(00,04)RSA-RC4128-MD5128 BitKey exchange: RSA, encryption: RC4, MAC: MD5.</div><div class="line">(00,35)RSA-AES256-SHA256 BitKey exchange: RSA, encryption: AES, MAC: SHA1.</div><div class="line">(00,0a)RSA-3DES-EDE-SHA56 BitKey exchange: RSA, encryption: 3DES, MAC: SHA1.</div><div class="line">(00,33)DHE-RSA-AES128-SHA128 BitKey exchange: DH, encryption: AES, MAC: SHA1.</div><div class="line">(00,39)DHE-RSA-AES256-SHA256 BitKey exchange: DH, encryption: AES, MAC: SHA1.</div><div class="line">(00,16)DHE-RSA-3DES-EDE-SHA168 BitKey exchange: DH, encryption: 3DES, MAC: SHA1.</div><div class="line"></div><div class="line">Further information:</div><div class="line"></div><div class="line">User-Agent:Mozilla/5.0 (Macintosh; Intel Mac OS X 10_8_3) AppleWebKit/536.29.13 (KHTML, like Gecko) Version/6.0.4 Safari/536.29.13</div><div class="line">Preferred SSL/TLS version: TLSv1</div><div class="line">SNI information: cc.dcsec.uni-hannover.de</div><div class="line">SSL stack current time: Sat, 27 Apr 2013 08:20:54</div><div class="line"></div><div class="line">This connection uses TLSv1 with AES128-SHA and a 128 Bit key for encryption.</div></pre></td></tr></table></figure>
<p>干，Safari 有支援 RC4 卻不給我使用，跑去用什麼 AES128-SHA 0rz…，所以我就想說奇怪為什麼有支援但是 nginx 單純設定 RC4 卻會失敗，於是在好奇之下就改成設定了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssl_ciphers RC4-SHA:HIGH:!aNULL:!MD5;</div></pre></td></tr></table></figure>
<p>結果… Safari 就好了… Fxck 真的很想罵髒話，nginx 送 RC4 給 curl、Chrome、Firefox 都看的懂，你 Safari 就看不懂直接中斷連線是怎樣 = =</p>
<p>Okay~ anyway，後來在網路也查不到什麼相關文章，不過我在網路上找到 BEAST Attack 的<a href="https://docs.google.com/viewer?url=http%3A%2F%2Fwww.phonefactor.com%2Fresources%2FCipherSuiteMitigationForBeast.pdf" target="_blank" rel="external">白皮書</a> 裡面推薦把 Web Server Cipher 設定成 <code>!aNULL:!eNULL:!EXPORT:!DSS:!DE
S:!SSLv2:RC4-SHA:RC4-MD5:ALL</code>，經過測試這樣的順序 Safari 也可以正確的判讀 (因為 RC4-SHA:RC4-MD5 都明確說明了啊！)，不過基於 MD5 的 digest 似乎有 collision 的機率現在好像都不推薦使用，所以原本有個 <code>!MD5</code>，於是最後我在我們 Server 上就改成了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssl_ciphers !aNULL:!eNULL:!EXPORT:!DSS:!DES:!MD5:RC4-SHA:ALL;</div></pre></td></tr></table></figure>
<p>也就是不要 NULL， EXPORT 家族的，也不要 DSS、DES 的加密法，不要 MD5 的 digest，優先使用 RC4-SHA 跟剩下的其他加密/訊息驗證法，因為 RC4 跟 3DES 幾乎所有的 OS 都有支援，但是 3DES 效能是在太低會把 Server 拖一些下來，所以建議儘量使用 RC4 優先，這個網頁有速度的比較 <a href="http://zombe.es/post/4078724716/openssl-cipher-selection" target="_blank" rel="external">OpenSSL: Cipher Selection</a> 可以看到 RC4 是快很多的，但是在有支援 AESNI 指令集的 CPU 上用 AES 速度更快 (可用 <code>grep aes /proc/cpuinfo</code> 檢查)，所以目前使用 RC4 是安全又快速的。最後如果要檢查 HTTPS 到底是不是安全，可以使用 <a href="https://www.ssllabs.com/ssltest/" target="_blank" rel="external">SSL Server Test</a> 來檢查。</p>
<p>如果對 BEAST 攻擊有興趣可以看這篇 <a href="http://securitystreetknowledge.com/?p=882" target="_blank" rel="external">SSL Beast – SSL Assessments and How to Fix</a></p>
<p>後來在測試 Mac 的 Agent 也可以連了，看起來是底層的 Framework 可能有問題。</p>
<h4 id="後記"><a href="#後記" class="headerlink" title="後記"></a>後記</h4><p>關於 SSL 其實有很多傳說 XDD，我還有看到人家說 OpenSSL 1.0.0 產生的憑證不能用在 Apache 上，跟我們的問題有點類似，因為我們自己內部網站用的 SSL 加一模一樣的 nginx 設定 (也就是只開 <code>RC4</code>) Safari 是完全沒問題的，這次出事的是我們對外服務的網站，但是因為憑證當初不是我申請的，所以問題已經無從追了，網路沒什麼反應也許 nginx 官網推薦的設定是真的 OK 的只是我們剛好踩到這個雷 %&gt;_&lt;%</p>
<p>另外也許文章一開始提到的，nginx 改用 OpenSSL 0.9.8y 可以是因為 Safari fallback 回去 SSLv3 的連線，所以就沒有使用奇奇怪怪的加密法，不然預設 Safari 也會優先使用 TLSv1。然後一用 TLSv1 配上我們的憑證也許 Safari 就傻了之類的 XD</p>
<h4 id="後記-x2"><a href="#後記-x2" class="headerlink" title="後記 x2"></a>後記 x2</h4><p>目前 SSL/TSL key 都是直接交換的方式也就是同一把 key 用久久，去年爆出 NSA 其實有在偷偷側錄 SSL/TSL 的流量，所以有個名詞突然紅了起來，就是 <code>Perfect Forward Secrecy</code>  (PFS)，他是建立在 D-H 上，也就是動態產生一組 session key 交換，這樣可以確保全部訊息沒有辦法被用同一把 key 給解開。因此參考 <a href="https://community.qualys.com/blogs/securitylabs/2013/08/05/configuring-apache-nginx-and-openssl-for-forward-secrecy" target="_blank" rel="external">Configuring Apache, Nginx, and OpenSSL for Forward Secrecy</a> 這裡，建議把設定改成下列：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</div><div class="line">ssl_prefer_server_ciphers on;</div><div class="line">ssl_ciphers &quot;EECDH+ECDSA+AESGCM EECDH+aRSA+AESGCM EECDH+ECDSA+SHA384 EECDH+ECDSA+SHA256 EECDH+aRSA+SHA384 EECDH+aRSA+SHA256 EECDH+aRSA+RC4 EECDH EDH+aRSA RC4-SHA !aNULL !eNULL !LOW !3DES !MD5 !EXP !PSK !SRP !DSS&quot;;</div></pre></td></tr></table></figure>
<p>我把原文章的 RC4 改成 RC4-SHA，經過測試後，Safari 也可用！</p>
<p>不過需要注意的是因為要打開橢圓曲線加密所以搭配 nginx 的 OpenSSL 最低需求要 1.0.1c 以上。</p>
<hr>
<p>參考資料</p>
<ul>
<li><a href="http://vincent.bernat.im/en/blog/2011-ssl-perfect-forward-secrecy.html" target="_blank" rel="external">SSL/TLS &amp; Perfect Forward Secrecy</a></li>
<li><a href="https://techzone.ergon.ch/ciphersuite" target="_blank" rel="external">SSL Ciphersuite Configuration for External HTTPS Connections</a></li>
</ul>

			  	</div>
				
		  	</article>
		  	
		  	<hr class="article-devider">
		  	
		  	<div class="homeLink">
		  		<a href="/"><strong class="article-nav-caption">HOME</strong></a>
		  	</div>
		  	
		  	<!-- article nav -->
		  	
			<nav id="article-nav">
			  
			    <a href="/post/e-m5-wooden-grip/" id="article-nav-newer" class="article-nav-link-wrap">
			      <strong class="article-nav-caption">Newer</strong>
			      <div class="article-nav-title">
			        
			          E-M5 木質手把
			        
			      </div>
			    </a>
			  
			  
			    <a href="/post/nginx---using-map-as-a-simple-web-application-firewall/" id="article-nav-older" class="article-nav-link-wrap">
			      <strong class="article-nav-caption">Older</strong>
			      <div class="article-nav-title">
			        
			          用 map 的功能把 nginx 變成簡單的應用程式防火牆
			        
			      </div>
			    </a>
			  
			</nav>
			
			
		</div>
		
		<footer id="footer">
		
			<div class="site-author-info">
		
				
				
				<div>
					<h6 class="authorCap">neoesque&nbsp;
						
					</h6>
					
				</div>
				
			</div>
			
			
			<div class="copyright-tool">
				<div class="copyright-title">
					<span>
					&copy; 2016&nbsp;neoesque
					</span>
				</div>
				
			</div>
			
			
		</footer>
	</div>
  	
  </body>
</html>