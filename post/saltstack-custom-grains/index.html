<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>saltstack 自定 grains | neoesque</title>
  <meta name="author" content="neoesque">
  
  <meta name="description" content="neoesque&#39;s Linux Blog">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="saltstack 自定 grains"/>
  <meta property="og:site_name" content="neoesque"/>

  
    <meta property="og:image" content="undefined"/>
  

  
    <link rel="alternative" href="/atom.xml" title="neoesque" type="application/atom+xml">
  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
<script type="text/javascript">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-37617901-1']);
_gaq.push(['_trackPageview']);
(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;

ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';

var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
</script>


</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">neoesque</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>彙整
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>分類
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>標籤
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>關於我
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">		
			<h1> saltstack 自定 grains</h1>
		</div>		
	



<div class="row post">
	<!-- cols -->
	
	<div class="col-md-9">
	

			

	<!-- content -->
	<div class="mypage">		
	    <p><a href="http://parseflo.at/post/nice-to-meet-saltstack/" target="_blank" rel="external">上一集</a> 中，簡單的介紹了 Salt 的使用方法，這集要稍微深入的介紹 Salt 的其中一個部份 - <a href="http://docs.saltstack.com/topics/targeting/grains.html" target="_blank" rel="external">Grains</a>，Grains 基本上就是機器的資訊，通常指的是不會變動的部份，比方說 CPU 有幾顆、記憶體有多少、作業系統是用什麼的(CentOS, Ubuntu, SUSE…etc)、網卡資訊，至於會變動的資訊通常會用 Salt 的 <a href="http://docs.saltstack.com/topics/pillar/index.html" target="_blank" rel="external">Pilar</a> 功能，雖然 SaltStack 支援很多種 Linux Distribution，而且他的 API 也儘可能的豐富每一個 Distro，像是套件管理系統就有支援 CentOS 的 yum、 Ubuntu 的 APT、 SUSE 的 zypper，但是終究不是每一個系統的特色都能夠完整的支援(可能需要自己貢獻上去?)，像是 SUSE Linux Enterprise Server (簡稱 SLES) 除了大版本號，還有小版本的 Service Pack，撰文的今天剛好出了 SLES 11 SP3，但是 Salt 內建的 Grains 只有偵測到 OS 是 SLES 就沒了，有時候我會依照不同的 Service Pack 需要不一樣的設定(因為 SP2 的套件有時候會支援某些功能，但是 SP1 時候還沒有，像是 sudoer 的設定)，但是不能判斷版本怎麼辦? 沒關係 Salt 具有高度擴充性，我們可以自定想要的 Grains。</p>
<a id="more"></a>
<p>我們先介紹一下內建的 Grains 有什麼好了，我們先隨便挑一台機器，<code>salt &#39;www-01&#39; grains.items</code>，如果執行有成功應該會出現如下的資訊：</p>
<pre><code>www-<span class="number">01</span>:
<span class="label">  biosreleasedate:</span> <span class="number">06</span><span class="regexp">/22/</span><span class="number">2012</span>
<span class="label">  biosversion:</span> <span class="number">6.00</span>
<span class="label">  cpu_flags:</span> fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts mmx fxsr sse sse2 ss ht syscall nx lm constant_tsc arch_perfmon pebs bts nopl tsc_reliable nonstop_tsc aperfmperf pni ssse3 cx16 sse4_1 x2apic hypervisor lahf_lm dtherm
<span class="label">  cpu_model:</span> Intel(R) Xeon(R) CPU           L5420  @ <span class="number">2.50</span>GHz
<span class="label">  cpuarch:</span> x86_64
<span class="label">  defaultencoding:</span> UTF8
<span class="label">  defaultlanguage:</span> zh_TW
<span class="label">  domain:</span> 
<span class="label">  fqdn:</span> www-<span class="number">01</span>
<span class="label">  gpus:</span>
      {<span class="string">'model'</span>: <span class="string">'SVGA II Adapter'</span>, <span class="string">'vendor'</span>: <span class="string">'unknown'</span>}
<span class="label">  host:</span> www-<span class="number">01</span>
<span class="label">  id:</span> www-<span class="number">01</span>
<span class="label">  ip_interfaces:</span> {<span class="string">'sit0'</span>: [], <span class="string">'lo'</span>: [<span class="string">'127.0.0.1'</span>], <span class="string">'eth0'</span>: [<span class="string">'192.168.1.1'</span>]}
<span class="label">  ipv4:</span>
      <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>
      <span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span>
<span class="label">  kernel:</span> Linux
<span class="label">  kernelrelease:</span> <span class="number">3.9</span><span class="number">.7</span>-neoesque
<span class="label">  localhost:</span> www-<span class="number">01</span>
<span class="label">  manufacturer:</span> VMware, Inc.
<span class="label">  master:</span> salt
<span class="label">  mem_total:</span> <span class="number">8016</span>
<span class="label">  nodename:</span> www-<span class="number">01</span>
<span class="label">  num_cpus:</span> <span class="number">4</span>
<span class="label">  num_gpus:</span> <span class="number">1</span>
<span class="label">  os:</span> SUSE  Enterprise Server
<span class="label">  os_family:</span> Suse
<span class="label">  oscodename:</span> x86_64
<span class="label">  osfullname:</span> SUSE Linux Enterprise Server
<span class="label">  osrelease:</span> <span class="number">11</span>
<span class="label">  path:</span> <span class="regexp">/sbin:/</span><span class="string">bin:</span><span class="regexp">/usr/</span><span class="string">sbin:</span><span class="regexp">/usr/</span>local<span class="regexp">/bin:/</span>usr<span class="regexp">/bin/</span>
<span class="label">  productname:</span> VMware Virtual Platform
<span class="label">  ps:</span> ps -efH
<span class="label">  pythonpath:</span>
      <span class="regexp">/usr/</span>local/bin
      <span class="regexp">/usr/</span>local<span class="regexp">/lib64/</span>python2<span class="number">.6</span><span class="regexp">/site-packages/</span>pip-<span class="number">1.3</span><span class="number">.1</span>-py2<span class="number">.6</span>.egg
      <span class="regexp">/usr/</span>lib/python26.zip
      <span class="regexp">/usr/</span>lib64/python2<span class="number">.6</span>
      <span class="regexp">/usr/</span>lib64<span class="regexp">/python2.6/</span>plat-linux2
      <span class="regexp">/usr/</span>lib64<span class="regexp">/python2.6/</span>lib-tk
      <span class="regexp">/usr/</span>lib64<span class="regexp">/python2.6/</span>lib-old
      <span class="regexp">/usr/</span>lib64<span class="regexp">/python2.6/</span>lib-dynload
      <span class="regexp">/usr/</span>lib64<span class="regexp">/python2.6/</span>site-packages
      <span class="regexp">/usr/</span>local<span class="regexp">/lib64/</span>python2<span class="number">.6</span>/site-packages
<span class="label">  pythonversion:</span> <span class="number">2.6</span><span class="number">.0</span>.<span class="keyword">final</span><span class="number">.0</span>
<span class="label">  saltpath:</span> <span class="regexp">/usr/</span>local<span class="regexp">/lib64/</span>python2<span class="number">.6</span><span class="regexp">/site-packages/</span>salt
<span class="label">  saltversion:</span> <span class="number">0.15</span><span class="number">.90</span>
<span class="label">  serialnumber:</span> VMware-<span class="number">42</span> <span class="number">30</span> <span class="number">04</span> <span class="number">4</span>b <span class="number">79</span> d2 c1 <span class="number">59</span>-<span class="number">92</span> <span class="number">2</span>b eb <span class="number">2</span>e <span class="number">71</span> d4 <span class="number">7</span>c <span class="number">63</span>
<span class="label">  server_id:</span> <span class="number">1323040866</span>
<span class="label">  shell:</span> <span class="regexp">/bin/</span>zsh
<span class="label">  virtual:</span> VMware
</code></pre><p>如果想要單獨知道某一個，可以這樣下 <code>salt &#39;www-01&#39; grains.item os</code>這樣就只會出現</p>
<pre><code><span class="attribute">www-01</span>:
  <span class="attribute">os</span>: SUSE  Enterprise Server
</code></pre><p>但是從上面的資訊我們可以發現 Salt 與預設只能抓到剛剛說的 os: SLES 跟 osrelease: 11，並沒有我們想要的 service pack 的版本號，所以我們需要自己新增。</p>
<p>首先在 Master 的電腦的 Base 底下新增一個叫做 <strong>_grains</strong>的資料夾，如果是預設值也就是 <strong>/srv/salt/_grains</strong>，指令如下 <code>install -d /srv/salt/_grains</code>，然後隨便產生一個副檔名是 <strong>.py</strong> 的檔案就好，比方說我產生一個 <strong>os.py</strong>，然後內容如下:</p>
<p><code>vi /srv/salt/_grains/os.py</code></p>
<pre><code><span class="function"><span class="keyword">def</span> <span class="title">patch</span><span class="params">()</span>:</span>
    <span class="string">''' 
        return Service Pack Version
    '''</span>
    grains = {}
    <span class="keyword">for</span> line <span class="keyword">in</span> open(<span class="string">"/etc/SuSE-release"</span>):
        <span class="keyword">if</span> <span class="string">"PATCHLEVEL"</span> <span class="keyword">in</span> line:
            patch = int(line.split(<span class="string">"="</span>)[-<span class="number">1</span>])
    grains[<span class="string">'ospatch'</span>] = patch
    <span class="keyword">return</span> grains
</code></pre><p>因為 SUSE 的 SP 版本號存在 <strong>/etc/SuSE-release</strong>，所以這裏只是一個小小的 python code 去把我們要的資訊取出來，注意到的幾個關鍵是</p>
<ul>
<li>開頭不用 #!/usr/bin/python ，因為這個檔案原本 salt 就會直接餵給 python 吃而已</li>
<li>grains 這個變數可以直接覆寫，因為最後是 merge 結果的，所以 grains[‘ospatch’] = patch 最後你的 <code>grains.items</code> 裡面就會多一個 ospatch 的變數</li>
</ul>
<p>存檔後就可以準備下指令啦！首先是請各個 minion 來領檔案回去，所以就是 <code>salt &#39;*&#39; state.highstate</code>，下完之後這時候直接打 <code>salt &#39;www-01&#39; grains.item ospatch</code>，應該會沒顯示東西，因為這時候我們還沒更新資料，前面說過 grains 是 static 的，所以要更新資料我們要下 <code>salt &#39;*&#39; sys.reload_modules</code> 這樣 minion 就會重新 scan modules 了，接著我們就可以下看看 <code>salt &#39;*&#39; grains.item ospatch</code> 如果沒錯誤應該可以看到如下的結果</p>
<pre><code><span class="attribute">www-stage</span>:
  <span class="attribute">ospatch</span>: <span class="number">1</span>
<span class="attribute">www-02</span>:
  <span class="attribute">ospatch</span>: <span class="number">2</span>
<span class="attribute">www-01</span>:
  <span class="attribute">ospatch</span>: <span class="number">2</span>
<span class="attribute">www-03</span>:
  <span class="attribute">ospatch</span>: <span class="number">2</span>
<span class="attribute">www-04</span>:
  <span class="attribute">ospatch</span>: <span class="number">2</span>
</code></pre><p>自定 Grains 大概就是這麼一回事嘍~</p>
	  
	</div>

	<div>
  	<center>
	<div class="pagination">
<ul class="pagination">
	 
				
    	<li class="prev"><a href="/post/install-graylog2/" class="alignleft prev"><i class="fa fa-arrow-circle-o-left"></i>上一頁</a></li>
  		

        <li><a href="/archives"><i class="fa fa-archive"></i>Archive</a></li>

		
		   <li class="next"><a href="/post/casio-tr15/" class="alignright next">下一頁<i class="fa fa-arrow-circle-o-right"></i></a></li>         
        
	
</ul>
</div>

    </center>
	</div>
	
	<!-- comment -->
	
<section id="comment">
  <h2 class="title">留言</h2>

  
  	 <div id="disqus_thread">
     <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  	 </div>
  
</section>

	
	</div> <!-- col-md-9/col-md-12 -->
	
	
		<div class="col-md-3"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2013-07-10, Wed 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/資訊/">資訊<span>43</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/Linux/">Linux<span>19</span></a></li> <li><a href="/tags/SaltStack/">SaltStack<span>2</span></a></li>
    </ul>
	</div>
		

	<!-- toc -->
	<div class="meta-widget">
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

	

</div><!-- row -->

	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2015 neoesque
  
      with help from <a href="http://zespia.tw/hexo/" target="_blank">Hexo</a> and <a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a>. Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>.    
</p> </footer>
</div> <!-- container-narrow -->
  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>


<script type="text/javascript">
var disqus_shortname = 'parsefloat';
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


</body>
   </html>
